import sys
import angr
import claripy

def main(bin = './Crackme'):
    # Create an Angr project.
    project = angr.Project(bin)

    def skip_instruction(state):
        pass

    # project.hook(0x08048b44, skip_instruction, length=34)
    START_ADDR=  0X08048b60
    pass_len=0x54
    # Create a symbolic bitvector representing the parameters from the command line
    arg1 = claripy.BVS('arg1', pass_len*8)
    initial_state = project.factory.blank_state(addr=START_ADDR)
    # for i in range(pass_len):
    #     initial_state.solver.add(arg1.get_byte(i) >= chr(33))
    #     initial_state.solver.add(arg1.get_byte(i) <= chr(125))

    # Restrict to printable charsnb
    for byte in arg1.chop(8):
        initial_state.add_constraints(byte != '\x00') # null
        initial_state.add_constraints(byte >= ' ') # '\x20'
        initial_state.add_constraints(byte <= '~') # '\x7e'
    store_addr = initial_state.regs.ebp + 0x7c
    initial_state.memory.store(store_addr, arg1)
    # Create a simulation manager initialized with the starting state. It provides
    # a number of useful tools to search and execute the binary.
    simulation = project.factory.simgr(initial_state)

    # If the state that prints this message is found, then we have found the correct simulation
    def is_successful(state):
        stdout_output = state.posix.dumps(sys.stdout.fileno())
        if b'Good password' in stdout_output:
            return True
        else:
            return False
    # If the state that prints this message is found, then we have found the correct simulation
    def bad_path(state):
        stdout_output = state.posix.dumps(sys.stdout.fileno())
        if b'Try again' in stdout_output:
            return True
        else:
            return False
    # Explore simulations until the message is found
    simulation.explore(find=is_successful, avoid=bad_path)

    # Check that we have found a solution. The simulation.explore() method will
    # set simulation.found to a list of the states that it could find that reach
    # the instruction we asked it to search for. Remember, in Python, if a list
    # is empty, it will be evaluated as false, otherwise true.
    if simulation.found:
        # Just take the first found solution
        solution_state = simulation.found[0]

        # Print the string that Angr wrote to stdin; this is our solution.
        print(solution_state.posix.dumps(sys.stdout.fileno()))
        solution0 = (solution_state.solver.eval(arg1, cast_to=bytes))
        print(solution0)

    else:
        # If Angr could not find a path that reaches print_good_address, throw an
        # error. Perhaps you mistyped the print_good_address?
        raise Exception('Could not find the solution')


if __name__ == '__main__':
    main()
